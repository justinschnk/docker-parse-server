haproxy:
  image: 'tutum/haproxy:0.1'
  environment:
    - BACKEND_PORT=1337
  links:
    - 'parse-server'
    - 'mongo'
  ports:
    - "80:1337"
    - "27017:27017"
  restart: always
  roles:
    - 'global'

parse-server:
  #build: .
  image: yongjhih/parse-server
  environment:
    DATABASE_URI: $DATABASE_URI
    APP_ID: $APP_ID
    MASTER_KEY: $MASTER_KEY
    PARSE_MOUNT: $PARSE_MOUNT
    COLLECTION_PREFIX: $COLLECTION_PREFIX
    CLIENT_KEY: $CLIENT_KEY
    REST_API_KEY: $REST_API_KEY
    DOTNET_KEY: $DOTNET_KEY
    JAVASCRIPT_KEY: $JAVASCRIPT_KEY
    DOTNET_KEY: $DOTNET_KEY
    FILE_KEY: $FILE_KEY
    FACEBOOK_APP_IDS: $FACEBOOK_APP_IDS
  links:
    - mongo
  volumes_from:
    - parse-cloud-code
  restart: always

parse-cloud-code:
  #build: cloud/.
  image: yongjhih/parse-cloud-code
  volumes:
    - /parse/cloud
  command: "ls /parse/cloud"
  restart: always

mongo:
  image: mongo
  volumes_from:
    - mongo-data
#  command: "--smallfiles --logpath=/dev/null --setParameter failIndexKeyTooLong=false --rest --auth"
  command: "--smallfiles --logpath=/dev/null --setParameter failIndexKeyTooLong=false"
# ref. http://www.diogogmt.com/running-mongodb-with-docker-and-compose/
  restart: always

mongo-data:
  image: mongo
  volumes:
    - /data/db
  command: "--break-mongo"
  restart: always
